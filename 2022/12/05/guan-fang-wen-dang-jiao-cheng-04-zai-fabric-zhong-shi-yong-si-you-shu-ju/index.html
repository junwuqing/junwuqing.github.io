<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="官方文档教程04-在Fabric中使用私有数据, somewei">
    <meta name="description" content="官方文档教程04-在Fabric中使用私有数据本教程将演示如何使用私有数据集合（PDC）在区块链网络上为组织的授权peers提供私有数据的存储和检索。使用包含管理该集合的策略的集合定义文件来指定该集合。
本教程中的信息假定您了解私有数据存储">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>官方文档教程04-在Fabric中使用私有数据 | somewei</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.2"></head>


<body>
    

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">somewei</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">somewei</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/23.webp')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">官方文档教程04-在Fabric中使用私有数据</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E6%95%99%E7%A8%8B%E7%B1%BB/">
                                <span class="chip bg-color">教程类</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-12-05
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    8.8k
                </div>
                

                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="官方文档教程04-在Fabric中使用私有数据"><a href="#官方文档教程04-在Fabric中使用私有数据" class="headerlink" title="官方文档教程04-在Fabric中使用私有数据"></a>官方文档教程04-在Fabric中使用私有数据</h1><p>本教程将演示如何使用私有数据集合（PDC）在区块链网络上为组织的授权peers提供私有数据的存储和检索。使用包含管理该集合的策略的集合定义文件来指定该集合。</p>
<p>本教程中的信息假定您了解私有数据存储及其用例。有关详细信息，请查看私人数据。</p>
<p>注意：这些指令使用了Fabric v2.0发行版中引入的新的Fabric链码生命周期。如果您想使用前面的生命周期模型使用带链码的私有数据，请访问Fabric教程中使用私有数据的V1.4版本。</p>
<p>本教程将指导您通过以下步骤练习使用Fabric定义、配置和使用私有数据:</p>
<ol>
<li>资产转移私有数据示例用例</li>
<li>构建集合定义JSON文件</li>
<li>使用链码 API读取和写入私有数据</li>
<li>将私有数据智能合约部署到channel</li>
<li>注册身份</li>
<li>在私有数据中创建资产</li>
<li>作为授权peer查询私有数据</li>
<li>作为未授权peer查询私有数据</li>
<li>转移资产</li>
<li>清除私有资产</li>
<li>对私有资产使用索引</li>
<li>其他资源</li>
</ol>
<p>本教程将资产传输私有数据示例部署到Fabric测试网络，以演示如何创建、部署和使用私有数据集合。您应该已经完成了安装Fabric和Fabric示例的任务。</p>
<h2 id="1-资产转移私有数据示例用例"><a href="#1-资产转移私有数据示例用例" class="headerlink" title="1.资产转移私有数据示例用例"></a>1.资产转移私有数据示例用例</h2><p>此示例使用以下用例演示如何使用三个私有数据集合（assetCollection、Org1 MSP private Collection和Org2 MSP private Collection）在Org1和Org2之间传输资产:</p>
<p>Org1的成员创建一个新资产，以下称为所有者。资产的公开细节，包括所有者的身份，存储在名为assetCollection的私有数据汇集中。资产也是由所有者提供的评估价值创造的。评估值由各参与方用于同意资产转让，并仅存储在业主组织的集合中。在本例中，业主同意的初始评估值存储在Org1MSPPrivateCollection中。</p>
<p>要购买资产，买方需要同意与资产所有者相同的评估价值。在这一步中，买方（Org2的成员）使用智能合约功能“Gree To Transfer”创建交易协议并同意评估价值。该值存储在Org2MSPPrivateCollection集合中。现在，资产所有者可以使用智能合约功能“TransferAsset”将资产转让给买方。“TransferAsset”函数使用channel ledger上的哈希值来确认所有者和购买者在转移资产之前已经同意了相同的评估值。</p>
<p>在介绍转移方案之前，我们将讨论组织如何在 Fabric 中使用私有数据集合。</p>
<h2 id="2-构建集合定义JSON文件"><a href="#2-构建集合定义JSON文件" class="headerlink" title="2.构建集合定义JSON文件"></a>2.构建集合定义JSON文件</h2><p>在一组组织可以使用私有数据进行交易之前，channel上的所有组织都需要构建一个集合定义文件，该文件定义与每个链码相关联的私有数据集合。存储在私有数据汇集中的数据只分发给特定组织的peer，而不分发给channel的所有成员。集合定义文件描述组织可以从链码读取和写入的所有私有数据集合。</p>
<p>每个集合由以下属性定义:</p>
<ul>
<li><code>name</code>：集合的名称。</li>
<li><code>policy</code>：定义允许保留集合数据的组织peers。</li>
<li><code>requiredPeerCount</code>：将私有数据传播为 链码背书的条件。</li>
<li><code>maxPeerCount</code>: For data redundancy purposes, the number of other peers that the current endorsing peer will attempt to distribute the data to. If an endorsing peer goes down, these other peers are available at commit time if there are requests to pull the private data.</li>
<li><code>blockToLive</code>：对于价格或个人信息等非常敏感的信息，此值表示数据应以块为单位在私有数据库中保留多长时间。 数据将在私有数据库上保留指定数量的块，之后将被清除，使该数据从网络中过时。 要无限期地保留私有数据，即永不清除私有数据，请将 blockToLive 属性设置为 0。</li>
<li><code>memberOnlyRead</code>: 值为true表示peer端自动强制执行仅允许属于集合成员组织之一的客户端读取私有数据。</li>
<li><code>memberOnlyWrite</code>：值为 true 表示peer端自动强制只允许属于集合成员组织之一的客户端对私有数据进行改写。</li>
<li><code>endorsementPolicy</code>：定义为了写入私有数据集合而需要满足的背书策略。 集合级别背书策略覆盖链代码级别策略。 有关构建策略定义的更多信息，请参阅背书策略主题。</li>
</ul>
<p>使用链码的所有组织都需要部署相同的集合定义文件，即使该组织不属于任何集合。除了在集合文件中显式定义的集合外，每个组织还可以访问其peer上的隐式集合，该集合只能由其组织读取。有关使用隐式数据收集的示例，请参见Fabric中的安全资产传输。</p>
<p>资产转移私有数据示例包含一个 collections_config.json 文件，该文件定义了三个私有数据集合定义：assetCollection、Org1MSPPrivateCollection 和 Org2MSPPrivateCollection。</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// collections_config.json</span>

<span class="token punctuation">[</span>
   <span class="token punctuation">&#123;</span>
   <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"assetCollection"</span><span class="token punctuation">,</span>
   <span class="token property">"policy"</span><span class="token operator">:</span> <span class="token string">"OR('Org1MSP.member', 'Org2MSP.member')"</span><span class="token punctuation">,</span>
   <span class="token property">"requiredPeerCount"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
   <span class="token property">"maxPeerCount"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
   <span class="token property">"blockToLive"</span><span class="token operator">:</span><span class="token number">1000000</span><span class="token punctuation">,</span>
   <span class="token property">"memberOnlyRead"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token property">"memberOnlyWrite"</span><span class="token operator">:</span> <span class="token boolean">true</span>
   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
   <span class="token punctuation">&#123;</span>
   <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Org1MSPPrivateCollection"</span><span class="token punctuation">,</span>
   <span class="token property">"policy"</span><span class="token operator">:</span> <span class="token string">"OR('Org1MSP.member')"</span><span class="token punctuation">,</span>
   <span class="token property">"requiredPeerCount"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
   <span class="token property">"maxPeerCount"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
   <span class="token property">"blockToLive"</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span>
   <span class="token property">"memberOnlyRead"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token property">"memberOnlyWrite"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
   <span class="token property">"endorsementPolicy"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
       <span class="token property">"signaturePolicy"</span><span class="token operator">:</span> <span class="token string">"OR('Org1MSP.member')"</span>
   <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
   <span class="token punctuation">&#123;</span>
   <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Org2MSPPrivateCollection"</span><span class="token punctuation">,</span>
   <span class="token property">"policy"</span><span class="token operator">:</span> <span class="token string">"OR('Org2MSP.member')"</span><span class="token punctuation">,</span>
   <span class="token property">"requiredPeerCount"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
   <span class="token property">"maxPeerCount"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
   <span class="token property">"blockToLive"</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">,</span>
   <span class="token property">"memberOnlyRead"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
   <span class="token property">"memberOnlyWrite"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
   <span class="token property">"endorsementPolicy"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
       <span class="token property">"signaturePolicy"</span><span class="token operator">:</span> <span class="token string">"OR('Org2MSP.member')"</span>
   <span class="token punctuation">&#125;</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>代码解读：</p>
<p>assetCollection定义中的policy属性指定Org1和Org2都可以将集合存储在它们的peers上。memberOnlyRead和memberOnlyWrite参数用于指定只有Org1和Org2客户端可以读取和写入此集合。</p>
<p>Org1 MSP private Collection集合只允许Org1的peers在其私有数据库中拥有私有数据，而Org2 MSP private Collection集合只能由Org2的peers存储。endorsementPolicy参数用于创建特定于集合的背书策略。Org1MSPPrivateCollection或Org2MSPPrivateCollection的每个更新都需要得到在其peers上存储集合的组织的认可。我们将在本教程中看到如何使用这些集合来传输资产。</p>
<p>当使用 peer lifecycle chaincode commit 命令将链码定义提交到channel时，将部署此集合定义文件。 有关此过程的更多详细信息，请参见下文第 3 节。</p>
<h2 id="3-使用链码-API读取和写入私有数据"><a href="#3-使用链码-API读取和写入私有数据" class="headerlink" title="3.使用链码 API读取和写入私有数据"></a>3.使用链码 API读取和写入私有数据</h2><p>了解如何将channel上的数据私有化的下一步是在链码中构建数据定义。资产转移私有数据示例根据访问数据的方式将私有数据划分为三个独立的数据定义。</p>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token comment">// Peers in Org1 and Org2 will have this private data in a side database</span>
<span class="token comment">// Org1和Org2中的peers将在一个侧数据库中拥有这个私有数据</span>
<span class="token keyword">type</span> <span class="token class-name">Asset</span> struct <span class="token punctuation">&#123;</span>
	   <span class="token comment">//Type is used to distinguish the various types of objects in state database</span>
	   <span class="token comment">//type用于区分状态数据库中的各种类型的对象</span>
       Type  <span class="token builtin">string</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">json:"objectType"</span><span class="token template-punctuation string">`</span></span> 
       <span class="token constant">ID</span>    <span class="token builtin">string</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">json:"assetID"</span><span class="token template-punctuation string">`</span></span>
       Color <span class="token builtin">string</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">json:"color"</span><span class="token template-punctuation string">`</span></span>
       Size  int    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">json:"size"</span><span class="token template-punctuation string">`</span></span>
       Owner <span class="token builtin">string</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">json:"owner"</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// AssetPrivateDetails describes details that are private to owners</span>
<span class="token comment">// AssetPrivateDetails 描述所有者私有的详细信息</span>
<span class="token comment">// Only peers in Org1 will have this private data in a side database</span>
<span class="token comment">// 只有Org1中的peers将在一个侧面数据库中拥有这个私有数据</span>
<span class="token keyword">type</span> <span class="token class-name">AssetPrivateDetails</span> struct <span class="token punctuation">&#123;</span>
       <span class="token constant">ID</span>             <span class="token builtin">string</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">json:"assetID"</span><span class="token template-punctuation string">`</span></span>
       AppraisedValue int    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">json:"appraisedValue"</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Only peers in Org2 will have this private data in a side database</span>
<span class="token comment">// 只有Org2中的peers将在一个侧面数据库中拥有这个私有数据</span>
<span class="token keyword">type</span> <span class="token class-name">AssetPrivateDetails</span> struct <span class="token punctuation">&#123;</span>
       <span class="token constant">ID</span>             <span class="token builtin">string</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">json:"assetID"</span><span class="token template-punctuation string">`</span></span>
       AppraisedValue int    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">json:"appraisedValue"</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>具体而言，对私人数据的访问将受到以下限制：</p>
<ul>
<li>Object Type、color、size和owner存储在assetCollection中，因此根据收集策略（Org1和Org2）中的定义，channel的成员都是可见的。</li>
<li>资产的评估值存储在集合Org1MSPPrivateCollection或Org2MSPPrivateCollection中，具体位置取决于资产的所有者。该值只能由属于可以存储集合的组织的用户访问。</li>
</ul>
<p>资产转移私有数据样本智能合约创建的所有数据都存储在 PDC 中。 智能合约使用 Fabric 链码 API，通过 GetPrivateData() 和 PutPrivateData() 函数将私有数据读取和写入私有数据集合。 您可以在此处找到有关这些功能的更多信息。 此私有数据存储在peer的私有状态数据库中（与公共状态数据库分开），并通过八卦协议在授权peer之间传播。</p>
<p>下图说明了私有数据示例使用的私有数据模型。 请注意，图中仅显示 Org3，以说明如果channel上有任何其他组织，他们将无权访问配置中定义的任何私有数据集合。</p>
<p><img src="https://hyperledger-fabric.readthedocs.io/en/latest/_images/SideDB-org1-org2.png" alt="_images/SideDB-org1-org2.png"></p>
<h3 id="3-1读取集合数据"><a href="#3-1读取集合数据" class="headerlink" title="3.1读取集合数据"></a>3.1读取集合数据</h3><p>智能合约使用链码 API GetPrivateData() 查询数据库中的私有数据。 GetPrivateData() 有两个参数，集合名称和数据键。 回想一下集合 assetCollection 允许 Org1 和 Org2 的peer节点在侧数据库中拥有私有数据，而集合 Org1MSPPrivateCollection 只允许 Org1 的peer节点在侧数据库中拥有他们的私有数据，而 Org2MSPPrivateCollection 允许 Org2 的peer节点在侧数据库中拥有他们的私有数据 侧数据库。 实现细节参考以下两个资产转账私有数据函数：</p>
<ul>
<li>ReadAsset 用于查询 assetID、color、size 和 owner 属性的值。</li>
<li>ReadAssetPrivateDetails 用于查询 appraisedValue 属性的值。</li>
</ul>
<p>当我们在本教程后面使用peer命令发出数据库查询时，我们将调用这两个函数。</p>
<h3 id="3-2写入私有数据"><a href="#3-2写入私有数据" class="headerlink" title="3.2写入私有数据"></a>3.2写入私有数据</h3><p>智能合约使用链码 API PutPrivateData（）将私有数据存储到私有数据库中。API还需要集合的名称。注意，资产转移私有数据示例包括三个不同的私有数据集合，但在链码中调用了两次（在本场景中充当Org1）。</p>
<ol>
<li>使用assetCollection集合写入私有数据assetID、颜色、大小和所有者。</li>
<li>使用 Org1MSPPrivateCollection 集合写入私有数据 appraisedValue。</li>
</ol>
<p>如果我们充当Org2，我们将用Org2 MSP Private Collection替换Org1MSPPrivateCollection。</p>
<p>例如，在CreateAsset函数的以下代码片段中，PutPrivateData（）被调用了两次，每一组私有数据调用一次。</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// CreateAsset creates a new asset by placing the main asset details in the assetCollection</span>
<span class="token comment">// CreateAsset 通过将主要的资产详情放在 assetCollection 中来创建一个新的资产</span>
<span class="token comment">// that can be read by both organizations. The appraisal value is stored in the owners org specific collection.</span>
<span class="token comment">// 两个组织都可以读取。 appraisal value存储在所有者组织的特定集合中。</span>
func (s *SmartContract) CreateAsset(ctx contractapi.TransactionContextInterface) error <span class="token punctuation">&#123;</span>

    <span class="token comment">// Get new asset from transient map</span>
    <span class="token comment">// 从临时映射获取新资产</span>
    transientMap<span class="token punctuation">,</span> err <span class="token operator">:</span>= ctx.GetStub().GetTransient()
    if err != nil <span class="token punctuation">&#123;</span>
        return fmt.Errorf(<span class="token string">"error getting transient: %v"</span><span class="token punctuation">,</span> err)
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Asset properties are private, therefore they get passed in transient field, instead of func args</span>
    <span class="token comment">// 资产属性是私有的，因此它们在transient字段中传递，而不是在func a rds中传递</span>
    transientAssetJSON<span class="token punctuation">,</span> ok <span class="token operator">:</span>= transientMap<span class="token punctuation">[</span><span class="token string">"asset_properties"</span><span class="token punctuation">]</span>
    if !ok <span class="token punctuation">&#123;</span>
        <span class="token comment">//log error to stdout</span>
        return fmt.Errorf(<span class="token string">"asset not found in the transient map input"</span>)
    <span class="token punctuation">&#125;</span>

    type assetTransientInput struct <span class="token punctuation">&#123;</span>
        Type           string `json<span class="token operator">:</span><span class="token string">"objectType"</span>` <span class="token comment">//Type is used to distinguish the various types of objects in state database</span>
        ID             string `json<span class="token operator">:</span><span class="token string">"assetID"</span>`
        Color          string `json<span class="token operator">:</span><span class="token string">"color"</span>`
        Size           int    `json<span class="token operator">:</span><span class="token string">"size"</span>`
        AppraisedValue int    `json<span class="token operator">:</span><span class="token string">"appraisedValue"</span>`
    <span class="token punctuation">&#125;</span>

    var assetInput assetTransientInput
    err = json.Unmarshal(transientAssetJSON<span class="token punctuation">,</span> &amp;assetInput)
    if err != nil <span class="token punctuation">&#123;</span>
        return fmt.Errorf(<span class="token string">"failed to unmarshal JSON: %v"</span><span class="token punctuation">,</span> err)
    <span class="token punctuation">&#125;</span>

    if len(assetInput.Type) == <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        return fmt.Errorf(<span class="token string">"objectType field must be a non-empty string"</span>)
    <span class="token punctuation">&#125;</span>
    if len(assetInput.ID) == <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        return fmt.Errorf(<span class="token string">"assetID field must be a non-empty string"</span>)
    <span class="token punctuation">&#125;</span>
    if len(assetInput.Color) == <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        return fmt.Errorf(<span class="token string">"color field must be a non-empty string"</span>)
    <span class="token punctuation">&#125;</span>
    if assetInput.Size &lt;= <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        return fmt.Errorf(<span class="token string">"size field must be a positive integer"</span>)
    <span class="token punctuation">&#125;</span>
    if assetInput.AppraisedValue &lt;= <span class="token number">0</span> <span class="token punctuation">&#123;</span>
        return fmt.Errorf(<span class="token string">"appraisedValue field must be a positive integer"</span>)
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Check if asset already exists</span>
    <span class="token comment">// 检查资产是否已经存在</span>
    assetAsBytes<span class="token punctuation">,</span> err <span class="token operator">:</span>= ctx.GetStub().GetPrivateData(assetCollection<span class="token punctuation">,</span> assetInput.ID)
    if err != nil <span class="token punctuation">&#123;</span>
        return fmt.Errorf(<span class="token string">"failed to get asset: %v"</span><span class="token punctuation">,</span> err)
    <span class="token punctuation">&#125;</span> else if assetAsBytes != nil <span class="token punctuation">&#123;</span>
        fmt.Println(<span class="token string">"Asset already exists: "</span> + assetInput.ID)
        return fmt.Errorf(<span class="token string">"this asset already exists: "</span> + assetInput.ID)
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Get ID of submitting client identity</span>
    <span class="token comment">// 获取提交客户端身份的ID</span>
    clientID<span class="token punctuation">,</span> err <span class="token operator">:</span>= submittingClientIdentity(ctx)
    if err != nil <span class="token punctuation">&#123;</span>
        return err
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Verify that the client is submitting request to peer in their organization</span>
    <span class="token comment">// // 验证客户端是否正在向其组织中的peer提交请求</span>
    <span class="token comment">// This is to ensure that a client from another org doesn't attempt to read or</span>
    <span class="token comment">// write private data from this peer.</span>
    <span class="token comment">//// 这是为了确保来自另一个组织的客户端不会试图从这个peer端读取或写入私有数据。</span>
    err = verifyClientOrgMatchesPeerOrg(ctx)
    if err != nil <span class="token punctuation">&#123;</span>
        return fmt.Errorf(<span class="token string">"CreateAsset cannot be performed: Error %v"</span><span class="token punctuation">,</span> err)
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Make submitting client the owner</span>
    <span class="token comment">// 使提交客户端成为所有者</span>
    asset <span class="token operator">:</span>= Asset<span class="token punctuation">&#123;</span>
        Type<span class="token operator">:</span>  assetInput.Type<span class="token punctuation">,</span>
        ID<span class="token operator">:</span>    assetInput.ID<span class="token punctuation">,</span>
        Color<span class="token operator">:</span> assetInput.Color<span class="token punctuation">,</span>
        Size<span class="token operator">:</span>  assetInput.Size<span class="token punctuation">,</span>
        Owner<span class="token operator">:</span> clientID<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
    assetJSONasBytes<span class="token punctuation">,</span> err <span class="token operator">:</span>= json.Marshal(asset)
    if err != nil <span class="token punctuation">&#123;</span>
        return fmt.Errorf(<span class="token string">"failed to marshal asset into JSON: %v"</span><span class="token punctuation">,</span> err)
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Save asset to private data collection</span>
    <span class="token comment">// 将资产保存到私有数据集合</span>
    <span class="token comment">// Typical logger, logs to stdout/file in the fabric managed docker container, running this chaincode</span>
    <span class="token comment">// 日志记录器，在fabric托管的docker容器中记录stdout/file并运行下面的链码</span>
    <span class="token comment">// Look for container name like dev-peer0.org1.example.com-&#123;chaincodename_version&#125;-xyz</span>
    <span class="token comment">// 寻找像 dev-peer0.org1.example.com-&#123;chaincodename_version&#125;-xyz 这样的容器名称</span>
    log.Printf(<span class="token string">"CreateAsset Put: collection %v, ID %v, owner %v"</span><span class="token punctuation">,</span> assetCollection<span class="token punctuation">,</span> assetInput.ID<span class="token punctuation">,</span> clientID)

    err = ctx.GetStub().PutPrivateData(assetCollection<span class="token punctuation">,</span> assetInput.ID<span class="token punctuation">,</span> assetJSONasBytes)
    if err != nil <span class="token punctuation">&#123;</span>
        return fmt.Errorf(<span class="token string">"failed to put asset into private data collection: %v"</span><span class="token punctuation">,</span> err)
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Save asset details to collection visible to owning organization</span>
    <span class="token comment">// 将资产详细信息保存到对拥有组织可见的集合</span>
    assetPrivateDetails <span class="token operator">:</span>= AssetPrivateDetails<span class="token punctuation">&#123;</span>
        ID<span class="token operator">:</span>             assetInput.ID<span class="token punctuation">,</span>
        AppraisedValue<span class="token operator">:</span> assetInput.AppraisedValue<span class="token punctuation">,</span>
    <span class="token punctuation">&#125;</span>
	<span class="token comment">//将资产详细信息封装到JSON</span>
    <span class="token comment">// marshal asset details to JSON</span>
    assetPrivateDetailsAsBytes<span class="token punctuation">,</span> err <span class="token operator">:</span>= json.Marshal(assetPrivateDetails)
    if err != nil <span class="token punctuation">&#123;</span>
        return fmt.Errorf(<span class="token string">"failed to marshal into JSON: %v"</span><span class="token punctuation">,</span> err)
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Get collection name for this organization.</span>
    <span class="token comment">// 获取该组织的集合名称。</span>
    orgCollection<span class="token punctuation">,</span> err <span class="token operator">:</span>= getCollectionName(ctx)
    if err != nil <span class="token punctuation">&#123;</span>
        return fmt.Errorf(<span class="token string">"failed to infer private collection name for the org: %v"</span><span class="token punctuation">,</span> err)
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// Put asset appraised value into owners org specific private data collection</span>
    <span class="token comment">// 将资产appraised value放入所有者组织特定的私有数据集合中</span>
    log.Printf(<span class="token string">"Put: collection %v, ID %v"</span><span class="token punctuation">,</span> orgCollection<span class="token punctuation">,</span> assetInput.ID)
    err = ctx.GetStub().PutPrivateData(orgCollection<span class="token punctuation">,</span> assetInput.ID<span class="token punctuation">,</span> assetPrivateDetailsAsBytes)
    if err != nil <span class="token punctuation">&#123;</span>
        return fmt.Errorf(<span class="token string">"failed to put asset private details: %v"</span><span class="token punctuation">,</span> err)
    <span class="token punctuation">&#125;</span>
    return nil
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>总而言之，上面的 collections_config.json 策略定义允许 Org1 和 Org2 中的所有节点在其私有数据库中存储和处理资产转移私有数据资产 ID、颜色、大小、所有者。 但是只有 Org1 中的节点可以在 Org1 集合 Org1MSPPrivateCollection 中存储和处理 appraisedValue 键数据，只有 Org2 中的节点可以在 Org2 集合 Org2MSPPrivateCollection 中存储和处理 appraisedValue 键数据。</p>
<p>As an additional data privacy benefit, since a collection is being used, only the private data hashes go through orderer, not the private data itself, keeping private data confidential from orderer.</p>
<h2 id="4-启动网络"><a href="#4-启动网络" class="headerlink" title="4.启动网络"></a>4.启动网络</h2><p>现在我们准备逐步执行一些演示如何使用私有数据的命令。</p>
<p>在安装、定义和使用私有数据智能合约之前， 我们需要启动结构测试网络。为了本教程，我们希望 从已知的初始状态进行操作。以下命令将杀死任何活动 或过时的 Docker 容器并删除以前生成的项目。 因此，让我们运行以下命令来清理任何以前的 环境：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> fabric-samples/test-network
./network.sh down<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>在 test-network 目录中，您可以使用以下命令启动带有证书颁发机构和 CouchDB 的 Fabric 测试网络：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./network.sh up createChannel <span class="token parameter variable">-ca</span> <span class="token parameter variable">-s</span> couchdb<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>此命令将部署一个 Fabric 网络，该网络由一个名为 mychannel 的channel组成，具有两个组织（每个组织维护一个peer节点）、证书颁发机构和一个ordering，同时使用 CouchDB 作为状态数据库。 LevelDB 或 CouchDB 都可以与集合一起使用。 选择 CouchDB 是为了演示如何对私有数据使用索引。</p>
<p>注意：要使集合起作用，正确配置跨组织的八卦是很重要的。请参阅我们关于Gossip数据传播协议的文档，特别注意“锚点peer”部分。我们的教程并不关注gossip，因为它已经在测试网络中配置好了，但是当配置一个channel时，gossip锚节点对于集合的正确工作至关重要。</p>
<h2 id="5-将私有数据智能合约部署到通道"><a href="#5-将私有数据智能合约部署到通道" class="headerlink" title="5.将私有数据智能合约部署到通道"></a>5.将私有数据智能合约部署到通道</h2><p>我们现在可以使用test-network脚本将智能合约部署到channel。 从test-network目录运行以下命令。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./network.sh deployCC <span class="token parameter variable">-ccn</span> private <span class="token parameter variable">-ccp</span> <span class="token punctuation">..</span>/asset-transfer-private-data/chaincode-go/ <span class="token parameter variable">-ccl</span> go <span class="token parameter variable">-ccep</span> <span class="token string">"OR('Org1MSP.peer','Org2MSP.peer')"</span> <span class="token parameter variable">-cccg</span> <span class="token punctuation">..</span>/asset-transfer-private-data/chaincode-go/collections_config.json<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>注意，我们需要将私有数据集合定义文件的路径传递给命令。作为将链码部署到channel的一部分，channel上的两个组织必须传递相同的私有数据集合定义，作为Fabric链码生命周期的组成部分。我们还部署了链码级背书策略为“OR（‘Org1MSP.peer’，‘Org2MSP.peer’）”的智能合约。这允许Org1和Org2创建一个资产，而不需要从其他组织获得认可。您可以看到在发出上述命令后部署打印在日志中的链码所需的步骤。</p>
<p>当两个组织都使用 peer lifecycle chaincode approveformyorg 命令批准链码定义时，链码定义包括使用 –collections-config 标志的私有数据集合定义的路径。 您可以在终端中看到以下 approveformyorg 命令：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">peer lifecycle chaincode approveformyorg <span class="token parameter variable">-o</span> localhost:7050 <span class="token parameter variable">--ordererTLSHostnameOverride</span> orderer.example.com <span class="token parameter variable">--channelID</span> mychannel <span class="token parameter variable">--name</span> private <span class="token parameter variable">--version</span> <span class="token number">1.0</span> --collections-config <span class="token punctuation">..</span>/asset-transfer-private-data/chaincode-go/collections_config.json --signature-policy <span class="token string">"OR('Org1MSP.member','Org2MSP.member')"</span> --package-id <span class="token variable">$CC_PACKAGE_ID</span> <span class="token parameter variable">--sequence</span> <span class="token number">1</span> <span class="token parameter variable">--tls</span> <span class="token parameter variable">--cafile</span> <span class="token variable">$ORDERER_CA</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在channel成员同意将私有数据收集作为链码定义的一部分后，数据集合将使用 peer lifecycle chaincode commit 命令提交到channel。 如果您在日志中查找 commit 命令，您会发现它使用相同的 –collections-config 标志来提供集合定义的路径。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">peer lifecycle chaincode commit <span class="token parameter variable">-o</span> localhost:7050 <span class="token parameter variable">--ordererTLSHostnameOverride</span> orderer.example.com <span class="token parameter variable">--channelID</span> mychannel <span class="token parameter variable">--name</span> private <span class="token parameter variable">--version</span> <span class="token number">1.0</span> <span class="token parameter variable">--sequence</span> <span class="token number">1</span> --collections-config <span class="token punctuation">..</span>/asset-transfer-private-data/chaincode-go/collections_config.json --signature-policy <span class="token string">"OR('Org1MSP.member','Org2MSP.member')"</span> <span class="token parameter variable">--tls</span> <span class="token parameter variable">--cafile</span> <span class="token variable">$ORDERER_CA</span> <span class="token parameter variable">--peerAddresses</span> localhost:7051 <span class="token parameter variable">--tlsRootCertFiles</span> <span class="token variable">$ORG1_CA</span> <span class="token parameter variable">--peerAddresses</span> localhost:9051 <span class="token parameter variable">--tlsRootCertFiles</span> <span class="token variable">$ORG2_CA</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="6-注册身份"><a href="#6-注册身份" class="headerlink" title="6.注册身份"></a>6.注册身份</h2><p>私有数据转移智能合约支持属于网络的个人身份的所有权。在我们的场景中，资产的所有者将是Org1的成员，而买方将属于Org2。为了突出显示GetClientIdentity（）.Get ID（）API和用户证书中的信息之间的连接，我们将使用Org1和Org2证书颁发机构（CA）注册两个新的标识，然后使用CA生成每个标识的证书和私钥。</p>
<p>首先，我们需要设置以下环境变量来使用 Fabric CA 客户端：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/<span class="token punctuation">..</span>/bin:<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span><span class="token builtin class-name">:</span><span class="token environment constant">$PATH</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">FABRIC_CFG_PATH</span><span class="token operator">=</span><span class="token environment constant">$PWD</span>/<span class="token punctuation">..</span>/config/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>我们将使用Org1 CA创建身份资产所有者。将Fabric CA客户端设置为Org1 CA管理员的MSP（此标识由test-network脚本生成）:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">FABRIC_CA_CLIENT_HOME</span><span class="token operator">=</span><span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/peerOrganizations/org1.example.com/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>您可以使用 fabric-ca-client 工具注册一个新的所有者客户端身份：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">fabric-ca-client register <span class="token parameter variable">--caname</span> ca-org1 <span class="token parameter variable">--id.name</span> owner <span class="token parameter variable">--id.secret</span> ownerpw <span class="token parameter variable">--id.type</span> client <span class="token parameter variable">--tls.certfiles</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/fabric-ca/org1/tls-cert.pem"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>您现在可以通过向注册命令提供注册名称和密码来生成身份证书和 MSP 文件夹：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">fabric-ca-client enroll <span class="token parameter variable">-u</span> https://owner:ownerpw@localhost:7054 <span class="token parameter variable">--caname</span> ca-org1 <span class="token parameter variable">-M</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/peerOrganizations/org1.example.com/users/owner@org1.example.com/msp"</span> <span class="token parameter variable">--tls.certfiles</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/fabric-ca/org1/tls-cert.pem"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>运行以下命令将节点 OU 配置文件复制到所有者身份 MSP 文件夹中。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cp</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/peerOrganizations/org1.example.com/msp/config.yaml"</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/peerOrganizations/org1.example.com/users/owner@org1.example.com/msp/config.yaml"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>我们现在可以使用 Org2 CA 来创建买家身份。 将 Fabric CA 客户端设置为 Org2 CA 管理员：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">FABRIC_CA_CLIENT_HOME</span><span class="token operator">=</span><span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/peerOrganizations/org2.example.com/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>您可以使用 fabric-ca-client 工具注册一个新的所有者客户端身份：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">fabric-ca-client register <span class="token parameter variable">--caname</span> ca-org2 <span class="token parameter variable">--id.name</span> buyer <span class="token parameter variable">--id.secret</span> buyerpw <span class="token parameter variable">--id.type</span> client <span class="token parameter variable">--tls.certfiles</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/fabric-ca/org2/tls-cert.pem"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>我们现在可以生成注册身份 MSP 文件夹：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">fabric-ca-client enroll <span class="token parameter variable">-u</span> https://buyer:buyerpw@localhost:8054 <span class="token parameter variable">--caname</span> ca-org2 <span class="token parameter variable">-M</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/peerOrganizations/org2.example.com/users/buyer@org2.example.com/msp"</span> <span class="token parameter variable">--tls.certfiles</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/fabric-ca/org2/tls-cert.pem"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>运行以下命令将节点 OU 配置文件复制到买方身份 MSP 文件夹中。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cp</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/peerOrganizations/org2.example.com/msp/config.yaml"</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/peerOrganizations/org2.example.com/users/buyer@org2.example.com/msp/config.yaml"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="7-在私有数据中创建资产"><a href="#7-在私有数据中创建资产" class="headerlink" title="7.在私有数据中创建资产"></a>7.在私有数据中创建资产</h2><p>现在我们已经创建了资产所有者的身份，我们可以调用私有数据智能合约来创建新资产。 将以下命令集复制并粘贴到终端的test-network目录中：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/<span class="token punctuation">..</span>/bin:<span class="token environment constant">$PATH</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">FABRIC_CFG_PATH</span><span class="token operator">=</span><span class="token environment constant">$PWD</span>/<span class="token punctuation">..</span>/config/
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CORE_PEER_TLS_ENABLED</span><span class="token operator">=</span>true
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CORE_PEER_LOCALMSPID</span><span class="token operator">=</span><span class="token string">"Org1MSP"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="token operator">=</span><span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CORE_PEER_MSPCONFIGPATH</span><span class="token operator">=</span><span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/peerOrganizations/org1.example.com/users/owner@org1.example.com/msp
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CORE_PEER_ADDRESS</span><span class="token operator">=</span>localhost:7051<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们将使用 CreateAsset 函数创建一个存储在私有数据中的资产——assetID asset1，颜色为绿色，大小为 20，appraisedValue 为 100。回想一下，私有数据 appraisedValue 将与私有数据 assetID、颜色、大小分开存储。 为此，CreateAsset 函数调用 PutPrivateData() API 两次以保留私有数据，每个集合调用一次。 另请注意，私有数据是使用 –transient 标志传递的。 作为transient数据传递的输入不会保留在事务中，以保持数据的私密性。 transient数据作为二进制数据传递，因此在使用终端时必须对其进行 base64 编码。 我们使用环境变量来捕获 base64 编码值，并使用 tr 命令去除 linux base64 命令添加的有问题的换行符。</p>
<p>运行以下命令来创建资产：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">ASSET_PROPERTIES</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"&#123;<span class="token entity" title="\&quot;">\"</span>objectType<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>asset<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>assetID<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>asset1<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>color<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>green<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>size<span class="token entity" title="\&quot;">\"</span>:20,<span class="token entity" title="\&quot;">\"</span>appraisedValue<span class="token entity" title="\&quot;">\"</span>:100&#125;"</span> <span class="token operator">|</span> base64 <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token punctuation">\</span><span class="token punctuation">\</span>n<span class="token variable">)</span></span>
peer chaincode invoke <span class="token parameter variable">-o</span> localhost:7050 <span class="token parameter variable">--ordererTLSHostnameOverride</span> orderer.example.com <span class="token parameter variable">--tls</span> <span class="token parameter variable">--cafile</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem"</span> <span class="token parameter variable">-C</span> mychannel <span class="token parameter variable">-n</span> private <span class="token parameter variable">-c</span> <span class="token string">'&#123;"function":"CreateAsset","Args":[]&#125;'</span> <span class="token parameter variable">--transient</span> <span class="token string">"&#123;<span class="token entity" title="\&quot;">\"</span>asset_properties<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span><span class="token variable">$ASSET_PROPERTIES</span><span class="token entity" title="\&quot;">\"</span>&#125;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>您应该会看到类似于以下内容的结果：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>chaincodeCmd<span class="token punctuation">]</span> chaincodeInvokeOrQuery-<span class="token operator">></span>INFO 001 Chaincode invoke successful. result: status:200<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>请注意，上面的命令仅针对 Org1 对等体。 CreateAsset 事务写入两个集合，assetCollection 和 Org1MSPPrivateCollection。 Org1MSPPrivateCollection 需要 Org1 节点的背书才能写入集合，而 assetCollection 继承了链码的背书策略，“OR(‘Org1MSP.peer’,’Org2MSP.peer’)”。 来自 Org1 节点的背书可以满足两种背书策略，并且能够在没有来自 Org2 的背书的情况下创建资产。</p>
<h2 id="8-以授权peer身份查询私有数据"><a href="#8-以授权peer身份查询私有数据" class="headerlink" title="8.以授权peer身份查询私有数据"></a>8.以授权peer身份查询私有数据</h2><p>我们的集合定义允许Org1和Org2的所有peer节点在他们的侧数据库中拥有资产ID、颜色、大小和所有者私有数据，但只有Org1中的peer节点可以在其端数据库中拥有Org1对其评估值私有数据的意见。作为Org1中的授权peers，我们将查询这两组私有数据。</p>
<p>第一个查询命令调用 ReadAsset 函数，该函数将 assetCollection 作为参数传递。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// ReadAsset reads the information from collection</span>
<span class="token comment">// ReadAsset 从集合中读取信息</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>SmartContract<span class="token punctuation">)</span> <span class="token function">ReadAsset</span><span class="token punctuation">(</span>ctx contractapi<span class="token punctuation">.</span>TransactionContextInterface<span class="token punctuation">,</span> assetID <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Asset<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

     log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"ReadAsset: collection %v, ID %v"</span><span class="token punctuation">,</span> assetCollection<span class="token punctuation">,</span> assetID<span class="token punctuation">)</span>
     assetJSON<span class="token punctuation">,</span> err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">GetStub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetPrivateData</span><span class="token punctuation">(</span>assetCollection<span class="token punctuation">,</span> assetID<span class="token punctuation">)</span> <span class="token comment">//get the asset from chaincode state（从链码状态获取资产）</span>

     <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
         <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to read asset: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
     <span class="token punctuation">&#125;</span>

     <span class="token comment">//No Asset found, return empty response（没有找到资源，返回空响应）</span>
     <span class="token keyword">if</span> assetJSON <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
         log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v does not exist in collection %v"</span><span class="token punctuation">,</span> assetID<span class="token punctuation">,</span> assetCollection<span class="token punctuation">)</span>
         <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
     <span class="token punctuation">&#125;</span>

     <span class="token keyword">var</span> asset <span class="token operator">*</span>Asset
     err <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>assetJSON<span class="token punctuation">,</span> <span class="token operator">&amp;</span>asset<span class="token punctuation">)</span>
     <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
         <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to unmarshal JSON: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
     <span class="token punctuation">&#125;</span>

     <span class="token keyword">return</span> asset<span class="token punctuation">,</span> <span class="token boolean">nil</span>

 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第二个查询命令调用 ReadAssetPrivateDetails 函数，该函数将 Org1MSPPrivateDetails 作为参数传递。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// ReadAssetPrivateDetails reads the asset private details in organization specific collection</span>
<span class="token comment">// ReadAssetPrivateDetails 读取组织特定集合中的资产私有详细信息</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>SmartContract<span class="token punctuation">)</span> <span class="token function">ReadAssetPrivateDetails</span><span class="token punctuation">(</span>ctx contractapi<span class="token punctuation">.</span>TransactionContextInterface<span class="token punctuation">,</span> collection <span class="token builtin">string</span><span class="token punctuation">,</span> assetID <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>AssetPrivateDetails<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"ReadAssetPrivateDetails: collection %v, ID %v"</span><span class="token punctuation">,</span> collection<span class="token punctuation">,</span> assetID<span class="token punctuation">)</span>
     assetDetailsJSON<span class="token punctuation">,</span> err <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">GetStub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetPrivateData</span><span class="token punctuation">(</span>collection<span class="token punctuation">,</span> assetID<span class="token punctuation">)</span> <span class="token comment">// Get the asset from chaincode state（从链码状态获取资产）</span>
     <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
         <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to read asset details: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
     <span class="token punctuation">&#125;</span>
     <span class="token keyword">if</span> assetDetailsJSON <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
         log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"AssetPrivateDetails for %v does not exist in collection %v"</span><span class="token punctuation">,</span> assetID<span class="token punctuation">,</span> collection<span class="token punctuation">)</span>
         <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
     <span class="token punctuation">&#125;</span>

     <span class="token keyword">var</span> assetDetails <span class="token operator">*</span>AssetPrivateDetails
     err <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>assetDetailsJSON<span class="token punctuation">,</span> <span class="token operator">&amp;</span>assetDetails<span class="token punctuation">)</span>
     <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
         <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to unmarshal JSON: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
     <span class="token punctuation">&#125;</span>

     <span class="token keyword">return</span> assetDetails<span class="token punctuation">,</span> <span class="token boolean">nil</span>
 <span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们可以通过使用 ReadAsset 函数查询作为 Org1 的 assetCollection 集合来读取创建的资产的主要详细信息：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">peer chaincode query <span class="token parameter variable">-C</span> mychannel <span class="token parameter variable">-n</span> private <span class="token parameter variable">-c</span> <span class="token string">'&#123;"function":"ReadAsset","Args":["asset1"]&#125;'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>成功时，该命令将返回以下结果：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">&#123;</span><span class="token string">"objectType"</span><span class="token builtin class-name">:</span><span class="token string">"asset"</span>,<span class="token string">"assetID"</span><span class="token builtin class-name">:</span><span class="token string">"asset1"</span>,<span class="token string">"color"</span><span class="token builtin class-name">:</span><span class="token string">"green"</span>,<span class="token string">"size"</span>:20,<span class="token string">"owner"</span><span class="token builtin class-name">:</span><span class="token string">"x509::CN=appUser1,OU=admin,O=Hyperledger,ST=North Carolina,C=US::CN=ca.org1.example.com,O=org1.example.com,L=Durham,ST=North Carolina,C=US"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>资产的“所有者”是通过调用智能合约创建资产的身份。 私有数据智能合约使用 GetClientIdentity().GetID() API 读取身份证书的名称和颁发者。 您可以在所有者属性中看到身份证书的名称和颁发者。</p>
<p>作为 Org1 的成员查询 asset1 的 appraisedValue 私有数据。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">peer chaincode query <span class="token parameter variable">-C</span> mychannel <span class="token parameter variable">-n</span> private <span class="token parameter variable">-c</span> <span class="token string">'&#123;"function":"ReadAssetPrivateDetails","Args":["Org1MSPPrivateCollection","asset1"]&#125;'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>您应该会看到以下结果：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">&#123;</span><span class="token string">"assetID"</span><span class="token builtin class-name">:</span><span class="token string">"asset1"</span>,<span class="token string">"appraisedValue"</span>:100<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="9-以未经授权的peer身份查询私有数据"><a href="#9-以未经授权的peer身份查询私有数据" class="headerlink" title="9.以未经授权的peer身份查询私有数据"></a>9.以未经授权的peer身份查询私有数据</h2><p>现在我们将操作一个来自 Org2 的用户。 Org2 在其侧数据库中有资产转移私有数据 assetID、color、size、owner，如 assetCollection 策略中定义的，但不存储 Org1 的资产 appraisedValue 数据。 我们将查询两组私有数据。</p>
<h3 id="9-1切换到-Org2-中的peer"><a href="#9-1切换到-Org2-中的peer" class="headerlink" title="9.1切换到 Org2 中的peer"></a>9.1切换到 Org2 中的peer</h3><p>运行以下命令以 Org2 成员身份操作并查询 Org2 peer。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">CORE_PEER_LOCALMSPID</span><span class="token operator">=</span><span class="token string">"Org2MSP"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="token operator">=</span><span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CORE_PEER_MSPCONFIGPATH</span><span class="token operator">=</span><span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/peerOrganizations/org2.example.com/users/buyer@org2.example.com/msp
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CORE_PEER_ADDRESS</span><span class="token operator">=</span>localhost:9051<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="9-2查询私有数据-Org2-被授权"><a href="#9-2查询私有数据-Org2-被授权" class="headerlink" title="9.2查询私有数据 Org2 被授权"></a>9.2查询私有数据 Org2 被授权</h3><p>Org2中的节点应在其端数据库中拥有第一组资产转移私有数据（资产ID、颜色、大小和所有者），并可以使用通过assetCollection参数调用的ReadAsset（）函数访问该数据。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">peer chaincode query <span class="token parameter variable">-C</span> mychannel <span class="token parameter variable">-n</span> private <span class="token parameter variable">-c</span> <span class="token string">'&#123;"function":"ReadAsset","Args":["asset1"]&#125;'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>成功后，应该会看到类似于以下结果的内容：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">&#123;</span><span class="token string">"objectType"</span><span class="token builtin class-name">:</span><span class="token string">"asset"</span>,<span class="token string">"assetID"</span><span class="token builtin class-name">:</span><span class="token string">"asset1"</span>,<span class="token string">"color"</span><span class="token builtin class-name">:</span><span class="token string">"green"</span>,<span class="token string">"size"</span>:20,
<span class="token string">"owner"</span><span class="token builtin class-name">:</span><span class="token string">"x509::CN=appUser1,OU=admin,O=Hyperledger,ST=North Carolina,C=US::CN=ca.org1.example.com,O=org1.example.com,L=Durham,ST=North Carolina,C=US"</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="9-3查询私有数据-Org2-未被授权"><a href="#9-3查询私有数据-Org2-未被授权" class="headerlink" title="9.3查询私有数据 Org2 未被授权"></a>9.3查询私有数据 Org2 未被授权</h3><p>因为资产是由 Org1 创建的，所以与 asset1 关联的 appraisedValue 存储在 Org1MSPPrivateCollection 集合中。 该值不由 Org2 中的peer存储。 运行以下命令以证明资产的 appraisedValue 未存储在 Org2 peer的 Org2MSPPrivateCollection 中：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">peer chaincode query <span class="token parameter variable">-o</span> localhost:7050 <span class="token parameter variable">--ordererTLSHostnameOverride</span> orderer.example.com <span class="token parameter variable">--tls</span> <span class="token parameter variable">--cafile</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem"</span> <span class="token parameter variable">-C</span> mychannel <span class="token parameter variable">-n</span> private <span class="token parameter variable">-c</span> <span class="token string">'&#123;"function":"ReadAssetPrivateDetails","Args":["Org2MSPPrivateCollection","asset1"]&#125;'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>空响应表明资产1私有详细信息在买方（Org2）私有集合中不存在。</p>
<p>Org2 的用户也不能读取 Org1 私有数据集合：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">peer chaincode query <span class="token parameter variable">-C</span> mychannel <span class="token parameter variable">-n</span> private <span class="token parameter variable">-c</span> <span class="token string">'&#123;"function":"ReadAssetPrivateDetails","Args":["Org1MSPPrivateCollection","asset1"]&#125;'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>通过在集合配置文件中设置 “memberOnlyRead”: true，我们指定只有来自 Org1 的客户端才能从集合中读取数据。 尝试读取集合的 Org2 客户端只会得到以下响应：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Error: endorsement failure during query. response: status:500 message:<span class="token string">"failed to
read asset details: GET_STATE failed: transaction ID: d23e4bc0538c3abfb7a6bd4323fd5f52306e2723be56460fc6da0e5acaee6b23: tx
creator does not have read access permission on privatedata in chaincodeName:private collectionName: Org1MSPPrivateCollection"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>来自 Org2 的用户将只能看到私有数据的公共哈希。</p>
<h2 id="10-转移资产"><a href="#10-转移资产" class="headerlink" title="10.转移资产"></a>10.转移资产</h2><p>让我们看看将 asset1 转移到 Org2 需要什么。 在这种情况下，Org2 需要同意从 Org1 购买资产，并且他们需要就 appraisedValue 达成一致。 您可能想知道，如果 Org1 将他们对 appraisedValue 的意见保留在他们的私人数据库中，他们怎么能达成一致。 对于这个问题的答案，让我们继续。</p>
<p>使用我们的peer CLI 切换回终端。</p>
<p>要转移资产，买方（接收者）需要通过调用链码函数 AgreeToTransfer 同意与资产所有者相同的 appraisedValue。 约定的值将存储在 Org2 peer的 Org2MSPDetailsCollection 集合中。 运行以下命令以同意appraisedValue为 100 作为 Org2：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">ASSET_VALUE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"&#123;<span class="token entity" title="\&quot;">\"</span>assetID<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>asset1<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>appraisedValue<span class="token entity" title="\&quot;">\"</span>:100&#125;"</span> <span class="token operator">|</span> base64 <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token punctuation">\</span><span class="token punctuation">\</span>n<span class="token variable">)</span></span>
peer chaincode invoke <span class="token parameter variable">-o</span> localhost:7050 <span class="token parameter variable">--ordererTLSHostnameOverride</span> orderer.example.com <span class="token parameter variable">--tls</span> <span class="token parameter variable">--cafile</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem"</span> <span class="token parameter variable">-C</span> mychannel <span class="token parameter variable">-n</span> private <span class="token parameter variable">-c</span> <span class="token string">'&#123;"function":"AgreeToTransfer","Args":[]&#125;'</span> <span class="token parameter variable">--transient</span> <span class="token string">"&#123;<span class="token entity" title="\&quot;">\"</span>asset_value<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span><span class="token variable">$ASSET_VALUE</span><span class="token entity" title="\&quot;">\"</span>&#125;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>买家现在可以在 Org2 私有数据集合中查询他们同意的值：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">peer chaincode query <span class="token parameter variable">-o</span> localhost:7050 <span class="token parameter variable">--ordererTLSHostnameOverride</span> orderer.example.com <span class="token parameter variable">--tls</span> <span class="token parameter variable">--cafile</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem"</span> <span class="token parameter variable">-C</span> mychannel <span class="token parameter variable">-n</span> private <span class="token parameter variable">-c</span> <span class="token string">'&#123;"function":"ReadAssetPrivateDetails","Args":["Org2MSPPrivateCollection","asset1"]&#125;'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>调用将返回以下值：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">&#123;</span><span class="token string">"assetID"</span><span class="token builtin class-name">:</span><span class="token string">"asset1"</span>,<span class="token string">"appraisedValue"</span>:100<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>现在买方已同意以appraisedValue购买资产，所有者可以将资产转让给 Org2。 资产需要通过拥有该资产的身份进行转移，所以让我们以 Org1 的身份进行操作：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">CORE_PEER_LOCALMSPID</span><span class="token operator">=</span><span class="token string">"Org1MSP"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CORE_PEER_MSPCONFIGPATH</span><span class="token operator">=</span><span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/peerOrganizations/org1.example.com/users/owner@org1.example.com/msp
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="token operator">=</span><span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CORE_PEER_ADDRESS</span><span class="token operator">=</span>localhost:7051<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>Org1 的所有者可以读取 AgreeToTransfer 交易添加的数据以查看买家身份：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">peer chaincode query <span class="token parameter variable">-o</span> localhost:7050 <span class="token parameter variable">--ordererTLSHostnameOverride</span> orderer.example.com <span class="token parameter variable">--tls</span> <span class="token parameter variable">--cafile</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem"</span> <span class="token parameter variable">-C</span> mychannel <span class="token parameter variable">-n</span> private <span class="token parameter variable">-c</span> <span class="token string">'&#123;"function":"ReadTransferAgreement","Args":["asset1"]&#125;'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">&#123;</span><span class="token string">"assetID"</span><span class="token builtin class-name">:</span><span class="token string">"asset1"</span>,<span class="token string">"buyerID"</span><span class="token builtin class-name">:</span><span class="token string">"eDUwOTo6Q049YnV5ZXIsT1U9Y2xpZW50LE89SHlwZXJsZWRnZXIsU1Q9Tm9ydGggQ2Fyb2xpbmEsQz1VUzo6Q049Y2Eub3JnMi5leGFtcGxlLmNvbSxPPW9yZzIuZXhhbXBsZS5jb20sTD1IdXJzbGV5LFNUPUhhbXBzaGlyZSxDPVVL"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>我们现在拥有转移资产所需的一切。 智能合约使用 GetPrivateDataHash() 函数检查 Org1MSPPrivateCollection 中appraisedValue的哈希值是否与 Org2MSPPrivateCollection 中appraisedValue的哈希值匹配。 如果哈希相同，则确认所有者和感兴趣的买家已同意相同的资产价值。 如果满足条件，转账功能将从转账协议中获取买方的客户 ID，并使买方成为资产的新所有者。 转让功能还将从前所有者的集合中删除资产评估值，并从资产集合中删除转让协议。</p>
<p>运行以下命令来转移资产。 Owner需要向转账交易提供assetID和买家的组织MSP ID：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">ASSET_OWNER</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"&#123;<span class="token entity" title="\&quot;">\"</span>assetID<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>asset1<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>buyerMSP<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>Org2MSP<span class="token entity" title="\&quot;">\"</span>&#125;"</span> <span class="token operator">|</span> base64 <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token punctuation">\</span><span class="token punctuation">\</span>n<span class="token variable">)</span></span>
peer chaincode invoke <span class="token parameter variable">-o</span> localhost:7050 <span class="token parameter variable">--ordererTLSHostnameOverride</span> orderer.example.com <span class="token parameter variable">--tls</span> <span class="token parameter variable">--cafile</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem"</span> <span class="token parameter variable">-C</span> mychannel <span class="token parameter variable">-n</span> private <span class="token parameter variable">-c</span> <span class="token string">'&#123;"function":"TransferAsset","Args":[]&#125;'</span> <span class="token parameter variable">--transient</span> <span class="token string">"&#123;<span class="token entity" title="\&quot;">\"</span>asset_owner<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span><span class="token variable">$ASSET_OWNER</span><span class="token entity" title="\&quot;">\"</span>&#125;"</span> <span class="token parameter variable">--peerAddresses</span> localhost:7051 <span class="token parameter variable">--tlsRootCertFiles</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>您可以查询 asset1 以查看传输结果：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">peer chaincode query <span class="token parameter variable">-o</span> localhost:7050 <span class="token parameter variable">--ordererTLSHostnameOverride</span> orderer.example.com <span class="token parameter variable">--tls</span> <span class="token parameter variable">--cafile</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem"</span> <span class="token parameter variable">-C</span> mychannel <span class="token parameter variable">-n</span> private <span class="token parameter variable">-c</span> <span class="token string">'&#123;"function":"ReadAsset","Args":["asset1"]&#125;'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>结果将显示买方身份现在拥有该资产：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">&#123;</span><span class="token string">"objectType"</span><span class="token builtin class-name">:</span><span class="token string">"asset"</span>,<span class="token string">"assetID"</span><span class="token builtin class-name">:</span><span class="token string">"asset1"</span>,<span class="token string">"color"</span><span class="token builtin class-name">:</span><span class="token string">"green"</span>,<span class="token string">"size"</span>:20,<span class="token string">"owner"</span><span class="token builtin class-name">:</span><span class="token string">"x509::CN=appUser2, OU=client + OU=org2 + OU=department1::CN=ca.org2.example.com, O=org2.example.com, L=Hursley, ST=Hampshire, C=UK"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>资产的“所有者”现在具有买方身份</p>
<p>您还可以确认转移从Org1集合中删除了私有详细信息:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">peer chaincode query <span class="token parameter variable">-o</span> localhost:7050 <span class="token parameter variable">--ordererTLSHostnameOverride</span> orderer.example.com <span class="token parameter variable">--tls</span> <span class="token parameter variable">--cafile</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem"</span> <span class="token parameter variable">-C</span> mychannel <span class="token parameter variable">-n</span> private <span class="token parameter variable">-c</span> <span class="token string">'&#123;"function":"ReadAssetPrivateDetails","Args":["Org1MSPPrivateCollection","asset1"]&#125;'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>查询将返回空结果，因为资产私有数据已从 Org1 私有数据收集中删除。</p>
<h2 id="11-清除私有数据"><a href="#11-清除私有数据" class="headerlink" title="11.清除私有数据"></a>11.清除私有数据</h2><p>对于只需要在短时间内保留私有数据的用例，可以在一定数量的块后“清除”数据，只留下数据的哈希值作为事务的不可变的证据。如果数据包含其他事务使用过但不再需要的敏感信息，或者数据正在复制到脱机数据库，则组织可以决定清除私有数据。</p>
<p>我们示例中的 appraisedValue 数据包含组织可能希望在特定时间段后过期的私有协议。 因此，它具有有限的生命周期，并且可以使用集合定义中的 blockToLive 属性在指定数量的块在区块链上保持不变后被清除。</p>
<p>Org2MSPPrivateCollection 定义的 blockToLive 属性值为 3，这意味着该数据将在侧数据库中存在三个块，然后将被清除。 如果我们在通道上创建额外的块，Org2 同意的 appraisedValue 最终将被清除。 我们可以创建 3 个新块来演示：</p>
<p>在您的终端中运行以下命令以切换回作为Org2的成员操作，并以Org2 peer为目标:</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">CORE_PEER_LOCALMSPID</span><span class="token operator">=</span><span class="token string">"Org2MSP"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CORE_PEER_TLS_ROOTCERT_FILE</span><span class="token operator">=</span><span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CORE_PEER_MSPCONFIGPATH</span><span class="token operator">=</span><span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/peerOrganizations/org2.example.com/users/buyer@org2.example.com/msp
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CORE_PEER_ADDRESS</span><span class="token operator">=</span>localhost:9051<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们仍然可以在 Org2MSPPrivateCollection 中查询 appraisedValue：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">peer chaincode query <span class="token parameter variable">-o</span> localhost:7050 <span class="token parameter variable">--ordererTLSHostnameOverride</span> orderer.example.com <span class="token parameter variable">--tls</span> <span class="token parameter variable">--cafile</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem"</span> <span class="token parameter variable">-C</span> mychannel <span class="token parameter variable">-n</span> private <span class="token parameter variable">-c</span> <span class="token string">'&#123;"function":"ReadAssetPrivateDetails","Args":["Org2MSPPrivateCollection","asset1"]&#125;'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>您应该会在日志中看到打印的值：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">&#123;</span><span class="token string">"assetID"</span><span class="token builtin class-name">:</span><span class="token string">"asset1"</span>,<span class="token string">"appraisedValue"</span>:100<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>由于我们需要在清除私有数据之前跟踪我们添加了多少块，因此打开一个新的终端窗口并运行以下命令来查看 Org2 peer的私有数据日志。 注意最高的块号。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> logs peer0.org1.example.com <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-a</span> <span class="token parameter variable">-E</span> <span class="token string">'private|pvt|privdata'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>现在返回到我们作为 Org2 成员的终端并运行以下命令来创建三个新资产。 每个命令都会创建一个新块。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">ASSET_PROPERTIES</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"&#123;<span class="token entity" title="\&quot;">\"</span>objectType<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>asset<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>assetID<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>asset2<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>color<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>blue<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>size<span class="token entity" title="\&quot;">\"</span>:30,<span class="token entity" title="\&quot;">\"</span>appraisedValue<span class="token entity" title="\&quot;">\"</span>:100&#125;"</span> <span class="token operator">|</span> base64 <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token punctuation">\</span><span class="token punctuation">\</span>n<span class="token variable">)</span></span>
peer chaincode invoke <span class="token parameter variable">-o</span> localhost:7050 <span class="token parameter variable">--ordererTLSHostnameOverride</span> orderer.example.com <span class="token parameter variable">--tls</span> <span class="token parameter variable">--cafile</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem"</span> <span class="token parameter variable">-C</span> mychannel <span class="token parameter variable">-n</span> private <span class="token parameter variable">-c</span> <span class="token string">'&#123;"function":"CreateAsset","Args":[]&#125;'</span> <span class="token parameter variable">--transient</span> <span class="token string">"&#123;<span class="token entity" title="\&quot;">\"</span>asset_properties<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span><span class="token variable">$ASSET_PROPERTIES</span><span class="token entity" title="\&quot;">\"</span>&#125;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">ASSET_PROPERTIES</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"&#123;<span class="token entity" title="\&quot;">\"</span>objectType<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>asset<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>assetID<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>asset3<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>color<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>red<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>size<span class="token entity" title="\&quot;">\"</span>:25,<span class="token entity" title="\&quot;">\"</span>appraisedValue<span class="token entity" title="\&quot;">\"</span>:100&#125;"</span> <span class="token operator">|</span> base64 <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token punctuation">\</span><span class="token punctuation">\</span>n<span class="token variable">)</span></span>
peer chaincode invoke <span class="token parameter variable">-o</span> localhost:7050 <span class="token parameter variable">--ordererTLSHostnameOverride</span> orderer.example.com <span class="token parameter variable">--tls</span> <span class="token parameter variable">--cafile</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem"</span> <span class="token parameter variable">-C</span> mychannel <span class="token parameter variable">-n</span> private <span class="token parameter variable">-c</span> <span class="token string">'&#123;"function":"CreateAsset","Args":[]&#125;'</span> <span class="token parameter variable">--transient</span> <span class="token string">"&#123;<span class="token entity" title="\&quot;">\"</span>asset_properties<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span><span class="token variable">$ASSET_PROPERTIES</span><span class="token entity" title="\&quot;">\"</span>&#125;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">ASSET_PROPERTIES</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">"&#123;<span class="token entity" title="\&quot;">\"</span>objectType<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>asset<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>assetID<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>asset4<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>color<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>orange<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>size<span class="token entity" title="\&quot;">\"</span>:15,<span class="token entity" title="\&quot;">\"</span>appraisedValue<span class="token entity" title="\&quot;">\"</span>:100&#125;"</span> <span class="token operator">|</span> base64 <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token punctuation">\</span><span class="token punctuation">\</span>n<span class="token variable">)</span></span>
peer chaincode invoke <span class="token parameter variable">-o</span> localhost:7050 <span class="token parameter variable">--ordererTLSHostnameOverride</span> orderer.example.com <span class="token parameter variable">--tls</span> <span class="token parameter variable">--cafile</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem"</span> <span class="token parameter variable">-C</span> mychannel <span class="token parameter variable">-n</span> private <span class="token parameter variable">-c</span> <span class="token string">'&#123;"function":"CreateAsset","Args":[]&#125;'</span> <span class="token parameter variable">--transient</span> <span class="token string">"&#123;<span class="token entity" title="\&quot;">\"</span>asset_properties<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span><span class="token variable">$ASSET_PROPERTIES</span><span class="token entity" title="\&quot;">\"</span>&#125;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>返回到另一个终端并运行以下命令以确认新资产导致了创建了三个新块：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> logs peer0.org1.example.com <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-a</span> <span class="token parameter variable">-E</span> <span class="token string">'private|pvt|privdata'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>appraisedValue 现已从 Org2MSPDetailsCollection 私有数据集合中清除。 从 Org2 终端再次发出查询以查看响应为空。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">peer chaincode query <span class="token parameter variable">-o</span> localhost:7050 <span class="token parameter variable">--ordererTLSHostnameOverride</span> orderer.example.com <span class="token parameter variable">--tls</span> <span class="token parameter variable">--cafile</span> <span class="token string">"<span class="token variable">$&#123;<span class="token environment constant">PWD</span>&#125;</span>/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem"</span> <span class="token parameter variable">-C</span> mychannel <span class="token parameter variable">-n</span> private <span class="token parameter variable">-c</span> <span class="token string">'&#123;"function":"ReadAssetPrivateDetails","Args":["Org2MSPPrivateCollection","asset1"]&#125;'</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="12-对私有数据使用索引"><a href="#12-对私有数据使用索引" class="headerlink" title="12.对私有数据使用索引"></a>12.对私有数据使用索引</h2><p>索引也可以应用于私有数据集合，方法是将索引打包到META-INF/statedb/couchdb/collections/<collection_name>/indexes目录中的链码旁边。这里有一个示例索引。</collection_name></p>
<p>为了将链码部署到生产环境，建议在链码旁边定义任何索引，以便链码和支持索引作为一个单元自动部署，一旦链码安装在peer节点上并在channel上实例化。 当指定 –collections-config 标志指向集合 JSON 文件的位置时，关联的索引会在channel上的链码实例化时自动部署。</p>
<p>注意：无法创建用于隐式私有数据集合的索引。 隐式集合基于组织名称并自动创建。 名称的格式为 <em>implicit_org</em><OrgsMSPid> 请参阅 FAB-17916 了解更多信息。</OrgsMSPid></p>
<h2 id="13-结束"><a href="#13-结束" class="headerlink" title="13.结束"></a>13.结束</h2><p>使用完私有数据智能合约后，可以使用 network.sh 脚本关闭测试网络。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./network.sh down<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>此命令将关闭我们创建的网络的 CA、peer节点和ordering节点。 请注意，ledger上的所有数据都将丢失。 如果您想再次阅读本教程，您将从一个干净的初始状态开始。</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">普信摩羯妈宝凤凰下头搞笑男</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://junwuqing.github.io/2022/12/05/guan-fang-wen-dang-jiao-cheng-04-zai-fabric-zhong-shi-yong-si-you-shu-ju/">http://junwuqing.github.io/2022/12/05/guan-fang-wen-dang-jiao-cheng-04-zai-fabric-zhong-shi-yong-si-you-shu-ju/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">普信摩羯妈宝凤凰下头搞笑男</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E6%95%99%E7%A8%8B%E7%B1%BB/">
                                    <span class="chip bg-color">教程类</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/12/06/guan-fang-wen-dang-jiao-cheng-05-fabric-zhong-de-an-quan-zi-chan-zhuan-yi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/20.webp" class="responsive-img" alt="官方文档教程05-Fabric 中的安全资产转移~">
                        
                        <span class="card-title">官方文档教程05-Fabric 中的安全资产转移~</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-12-06
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            普信摩羯妈宝凤凰下头搞笑男
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%95%99%E7%A8%8B%E7%B1%BB/">
                        <span class="chip bg-color">教程类</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/12/05/guan-fang-wen-dang-jiao-cheng-03-yun-xing-wai-bu-lian-ma-sheng-cheng-qi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/3.webp" class="responsive-img" alt="官方文档教程03-运行外部链码生成器">
                        
                        <span class="card-title">官方文档教程03-运行外部链码生成器</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-12-05
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            普信摩羯妈宝凤凰下头搞笑男
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%95%99%E7%A8%8B%E7%B1%BB/">
                        <span class="chip bg-color">教程类</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: somewei<br />'
            + '文章作者: 普信摩羯妈宝凤凰下头搞笑男<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022</span>
            
            <a href="/about" target="_blank">普信摩羯妈宝凤凰下头搞笑男</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">51.7k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/junwuqing" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1275017708@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1275017708" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1275017708" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
        
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/sakura.js"><\/script>');
            }
        </script>
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

    
        <script type="text/javascript">
        //只在桌面版网页启用特效
        var windowWidth = $(window).width();
        if (windowWidth > 768) {
            document.write('<script type="text/javascript" src="/js/sakura.js" />');
        }
        </script>
    
   
        

</body>

</html>
